<%! from django.utils.translation import ugettext as _ %>
<%! from django.core.urlresolvers import reverse %>
<%! from microsite_configuration import microsite %>

<%inherit file="main.html" />

<%namespace name='static' file='static_content.html'/>
<%namespace file='main.html' import="login_query, stanford_theme_enabled"/>

<%! from django.core.urlresolvers import reverse %>
<%! from django.utils import html %>
<%! from django_countries import countries %>
<%! from django.utils.translation import ugettext as _ %>
<%! from student.models import UserProfile %>
<%! from datetime import date %>
<%! import third_party_auth %>
<%! from third_party_auth import pipeline, provider %>
<%! import calendar %>

<%block name="pagetitle">${_("Register for {platform_name}").format(platform_name=platform_name)}</%block>

<%block name="bodyclass">view-register</%block>

<%block name="js_extra">
  <script type="text/javascript">
    $(function() {

      // adding js class for styling with accessibility in mind
      $('body').addClass('js');

      // new window/tab opening
      $('a[rel="external"], a[class="new-vp"]')
      .click( function() {
      window.open( $(this).attr('href') );
      return false;
      });

      // form field label styling on focus
      $("form :input").focus(function() {
        $("label[for='" + this.id + "']").parent().addClass("is-focused");
      }).blur(function() {
        $("label").parent().removeClass("is-focused");
      });

    });

    (function() {
      toggleSubmitButton(true);

      $('#register-form').on('submit', function() {
        toggleSubmitButton(false);
      });

      $('#register-form').on('ajax:error', function() {
        toggleSubmitButton(true);
      });

      $('#register-form').on('ajax:success', function(event, json, xhr) {
        var url = json.redirect_url || "${reverse('dashboard')}";
        location.href = url;
      });

      $('#register-form').on('ajax:error', function(event, jqXHR, textStatus) {
        toggleSubmitButton(true);
        json = $.parseJSON(jqXHR.responseText);
        $('.status.message.submission-error').addClass('is-shown').focus();
        $('.status.message.submission-error .message-copy').html(json.value).stop().css("display", "block");
        $(".field-error").removeClass('field-error');
        $("[data-field='"+json.field+"']").addClass('field-error')
      });
    })(this);

    function thirdPartySignin(event, url) {
      event.preventDefault();
      window.location.href = url;
    }

    function toggleSubmitButton(enable) {
      var $submitButton = $('form .form-actions #submit');

      if(enable) {
        $submitButton.
          removeClass('is-disabled').
          attr('aria-disabled', false).
          removeProp('disabled').
          html("${_('Create My {platform_name} Account').format(platform_name=platform_name)}");
      }
      else {
        $submitButton.
          addClass('is-disabled').
          prop('disabled', true).
          text("${_('Processing your account information')}");
      }
    }
  </script>
</%block>

<section class="bg-photo-hero">
  <div class="container-bs">
    <div class="bg-photo-hero__content">
      <div class="bg-photo-hero__content__text">
        <h1>${_("Welcome")}</h1>
        <p>${_("Register below to create your {platform_name} account").format(platform_name=platform_name)}</p>
      </div>
    </div>
  </div>
</section>

<section class="signup-form">
  <div class="container-bs">
    <div class="row">
      <div class="col-xs-12 col-sm-8 col-md-7">
        <form role="form" id="register-form" method="post" data-remote="true" action="/create_account" novalidate>

          <input type="hidden" name="csrfmiddlewaretoken" value="${ csrf_token }">

          <!-- Status messages -->
          <div role="alert" class="form__status-message status message form-alert">
            <h3 class="form__status-message__title">${_("We're sorry, {platform_name} enrollment is not available in your region").format(platform_name=platform_name)}</h3>
          </div>
          <div role="alert" class="form__status-message status message submission-error form-error">
            <h3 class="form__status-message__title">${_("The following errors occurred while processing your registration:")}</h3>
            <ul class="message-copy"> </ul>
          </div>

          % if third_party_auth.is_enabled():

            % if not running_pipeline:

              <div class="signup-form__group form__group">

                % for enabled in provider.Registry.enabled():
                  ## Translators: provider_name is the name of an external, third-party user authentication service (like Google or LinkedIn).
                  <button type="submit" class="signup-form__button form__button" onclick="thirdPartySignin(event, '${pipeline_urls[enabled.NAME]}');"><span class="icon fa ${enabled.ICON_CLASS}"></span>${_('Sign up with {provider_name}').format(provider_name=enabled.NAME)}</button>
                % endfor

              </div>

              <span class="deco-divider">
                ## Developers: this is a sentence fragment, which is usually frowned upon.  The design of the pags uses this fragment to provide an "else" clause underneath a number of choices.  It's OK to leave it.
                ## Translators: this is the last choice of a number of choices of how to log in to the site.
                <span class="copy">${_('or')}</span>
              </span>

              <h3 class="signup-form__instructions">
                ${_('Create your own {platform_name} account below').format(platform_name=platform_name)}
              </h3>
              <h3 class="signup-form__instructions">
                ${_('Required fields are noted by <strong class="indicator">bold text and an asterisk (*)</strong>.')}
              </h3>

            % else:

              ## Translators: selected_provider is the name of an external, third-party user authentication service (like Google or LinkedIn).
              <h3 class="signup-form__instructions">
                ${_("You've successfully signed in with {selected_provider}.").format(selected_provider='<strong>%s</strong>' % selected_provider)}<br />${_("We just need a little more information before you start learning with {platform_name}.").format(platform_name=settings.PLATFORM_NAME)}
              </h3>

            % endif

          % else:

            <h3 class="signup-form__instructions">
              ${_("Please complete the following fields to register for an account. ")}<br />${_('Required fields are noted by <strong class="indicator">bold text and an asterisk (*)</strong>.')}
            </h3>

          % endif

          <div class="signup-form__group form__group">

            % if has_extauth_info is UNDEFINED:

              <label for="email" class="signup-form__label form__label required">${_('E-mail')} *</label>
              <input id="email" type="email" class="signup-form__input form__input" name="email" value="${email}" placehoder="${_('example: username@domain.com')}" required aria-required="true" />

              <label for="name" class="signup-form__label form__label required">${_('Full Name')} *</label>
              <input id="name" type="text" name="name" class="signup-form__input form__input" placehoder="${_('example: Jane Doe')}" required aria-required="true" aria-describedby="name-tip" />
              <span class="signup-form__input-clarification form__input-clarification">${_("Needed for any certificates you may earn")}</span>

              <label for="username" class="signup-form__label form__label required">${_('Public Username')} *</label>
              <input id="username" type="text" class="signup-form__input form__input" name="username" value="${username}" placehoder="${_('example: JaneDoe')}" required aria-required="true" aria-describedby="username-tip"/>
              <span class="signup-form__input-clarification form__input-clarification">${_('Will be shown in any discussions or forums you participate in')} (${_('cannot be changed later')}).</span>

              % if third_party_auth.is_enabled() and running_pipeline:

                <label for="password" class="signup-form__label form__label required">${_('Password')} *</label>
                <input id="password" type="password" class="signup-form__input form__input" name="password" value="" disabled required aria-required="true" />

              % else:

                <label for="password" class="signup-form__label form__label required">${_('Password')} *</label>
                <input id="password" type="password" class="signup-form__input form__input" name="password" value="" required aria-required="true" />

              % endif

            % else:

              <div class="form__status-message">
                <h3 class="form__status-message__title">${_("Welcome {username}").format(username=extauth_id)}</h3>
                <p class="form__status-message__text">${_("Enter a Public Display Name:")}</p>
              </div>

              % if ask_for_email:

                <label for="email" class="signup-form__label form__label required">${_('E-mail')} *</label>
                <input id="email" type="email" class="signup-form__input form__input" name="email" value="" placehoder="${_('example: username@domain.com')}" required aria-required="true" />

              % endif

              <label for="username" class="signup-form__label form__label required">${_('Public Display Name')} *</label>
              <input id="username" type="text" class="signup-form__input form__input" name="username" value="${extauth_username}" placehoder="${_('example: JaneDoe')}" required aria-required="true" aria-describedby="username-tip"/>
              <span class="signup-form__input-clarification form__input-clarification">${_('Will be shown in any discussions or forums you participate in')} <strong>(${_('cannot be changed later')})</strong></span>

              % if ask_for_fullname:

                <label for="name" class="signup-form__label form__label required">${_('Full Name')} *</label>
                <input id="name" type="text" name="name" class="signup-form__input form__input" placehoder="${_('example: Jane Doe')}" value="" required aria-required="true" aria-describedby="name-tip" />
                <span class="signup-form__input-clarification form__input-clarification">${_("Needed for any certificates you may earn")}</span>

              % endif

            % endif

          </div>

          <div class="signup-form__group form__group">

            % if settings.REGISTRATION_EXTRA_FIELDS['city'] != 'hidden':

              <label for="city" class="signup-form__label form__label required">${_('City')}</label>
              <input id="city" type="text" name="city" class="signup-form__input form__input" value="" placeholder="${_('example: New York')}" aria-describedby="city-tip" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['city'] == 'required' else ''} />

            % endif

            % if settings.REGISTRATION_EXTRA_FIELDS['country'] != 'hidden':

              <label for="country" class="signup-form__label form__label">${_("Country")}</label>
              <select class="signup-form__input form__input" id="country" name="country" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['country'] == 'required' else ''}>
                <option value="">--</option>

                %for code, country_name in sorted(countries.countries, key=lambda (__, name): unicode(name)):

                  <option value="${code}">${ unicode(country_name) }</option>

                %endfor

              </select>

            % endif

            <div class="row">

              <div class="col-xs-12 col-sm-6">

                % if settings.REGISTRATION_EXTRA_FIELDS['level_of_education'] != 'hidden':

                  <label for="education-level" class="signup-form__label form__label">${_("Highest Level of Education Completed")}</label>
                  <select class="signup-form__input form__input" id="education-level" name="level_of_education" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['level_of_education'] == 'required' else ''}>
                    <option value="">--</option>

                    %for code, ed_level in UserProfile.LEVEL_OF_EDUCATION_CHOICES:

                      <option value="${code}">${_(ed_level)}</option>

                    %endfor

                  </select>

                % endif

                </div>

              <div class="col-xs-12 col-sm-3">

                % if settings.REGISTRATION_EXTRA_FIELDS['gender'] != 'hidden':

                  <label for="gender" class="signup-form__label form__label">${_("Gender")}</label>
                  <select class="signup-form__input form__input" id="gender" name="gender" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['gender'] == 'required' else ''}>
                    <option value="">--</option>

                    %for code, gender in UserProfile.GENDER_CHOICES:

                      <option value="${code}">${_(gender)}</option>

                    %endfor

                  </select>

                % endif

              </div>

              <div class="col-xs-12 col-sm-3">

                % if settings.REGISTRATION_EXTRA_FIELDS['year_of_birth'] != 'hidden':

                  <label for="yob" class="signup-form__label form__label">${_("Year of Birth")}</label>
                  <select class="signup-form__input form__input" id="yob" name="year_of_birth" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['year_of_birth'] == 'required' else ''}>
                    <option value="">--</option>

                    %for year in UserProfile.VALID_YEARS:

                      <option value="${year}">${year}</option>

                    %endfor

                  </select>

                % endif

              </div>

            </div>

          </div>

          <div class="signup-form__group form__group">

            % if settings.REGISTRATION_EXTRA_FIELDS['mailing_address'] != 'hidden':

              <label for="address-mailing" class="signup-form__label form__label">${_("Mailing Address")}</label>
              <textarea class="signup-form__textarea form__textarea" id="address-mailing" name="mailing_address" value="" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['mailing_address'] == 'required' else ''}></textarea>

            % endif

            % if settings.REGISTRATION_EXTRA_FIELDS['goals'] != 'hidden':

              <label for="goals" class="signup-form__label form__label">${_("Please share with us your reasons for registering with {platform_name}").format(platform_name=platform_name)}</label>
              <textarea class="signup-form__textarea form__textarea" id="goals" name="goals" value="" ${'required aria-required="true"' if settings.REGISTRATION_EXTRA_FIELDS['goals'] == 'required' else ''}></textarea>

            % endif

          </div>

          <div class="signup-form__group form__group">

            % if has_extauth_info is UNDEFINED or ask_for_tos :

              <input class="signup-form__checkbox form__checkbox" id="tos-yes" type="checkbox" name="terms_of_service" value="true" required aria-required="true" />
              <label for="tos-yes" class="signup-form__checkbox-label form__checkbox-label">${_('I agree to the {link_start}Terms of Service{link_end}').format(
                link_start='<a href="{url}" class="new-vp" tabindex="-1">'.format(url=marketing_link('TOS')),
                link_end='</a>')}</label>

            % endif

            % if settings.REGISTRATION_EXTRA_FIELDS['honor_code'] != 'hidden':

               ## If the stanford theme isn't enabled, check if we have an Honor Code link in our marketing map

              % if not self.stanford_theme_enabled() and marketing_link('HONOR') and marketing_link('HONOR') != '#':

                <input class="signup-form__checkbox form__checkbox" id="honorcode-yes" type="checkbox" name="honor_code" value="true" />

                <%
                  ## TODO: provide a better way to override these links
                  if self.stanford_theme_enabled():
                    honor_code_path = marketing_link('TOS') + "#honor"
                  else:
                    honor_code_path = marketing_link('HONOR')
                %>

                <label for="honorcode-yes" class="signup-form__checkbox-label form__checkbox-label">${_('I agree to the {link_start}Honor Code{link_end}').format(
                link_start='<a href="{url}" class="new-vp" tabindex="-1">'.format(url=honor_code_path),
                link_end='</a>')}</label>

              % endif

            % endif

          </div>

          % if course_id and enrollment_action:
            <input type="hidden" name="enrollment_action" value="${enrollment_action | h}" />
            <input type="hidden" name="course_id" value="${course_id | h}" />
          % endif

          % if email_opt_in:
            <input type="hidden" name="email_opt_in" value="${email_opt_in | h }" />
          % endif

          <div class="signup-form__group form__group">
            <button class="signup-form__button form__button" name="submit" type="submit" id="submit">${_('Register')} and ${_('Create My Account')}</button>
          </div>

        </form>

      </div>


      <div class="col-xs-12 col-sm-4 col-md-5 signup-form__help">

        % if has_extauth_info is UNDEFINED:

          <div class="signup-form__help__group">
            <h4 class="signup-form__help__heading">
              ${_("Already registered?")}
            </h4>
            <a class="signup-form__help__login-button" href="${reverse('signin_user')}${login_query()}">${_("Log in")}</a>
          </div>

        % endif

        <div class="signup-form__help__group">
          <h4 class="signup-form__help__heading">
            ${_("Next Steps")}
          </h4>

          % if stanford_theme_enabled():

            <p>${_("You will receive an activation email.  You must click on the activation link to complete the process.  Don't see the email?  Check your spam folder and mark emails from class.stanford.edu as 'not spam', since you'll want to be able to receive email from your courses.")}</p>

          % else:

            <p>${_("As part of joining {platform_name}, you will receive an activation email.  You must click on the activation link to complete the process.  Don't see the email?  Check your spam folder and mark {platform_name} emails as 'not spam'.  At {platform_name}, we communicate mostly through email.").format(platform_name=platform_name)}</p>

          % endif

        </div>

        % if settings.MKTG_URL_LINK_MAP.get('FAQ'):

          <div class="signup-form__help__group">
            <h4 class="signup-form__help__heading">
              ${_("Need Help?")}
            </h4>
            <p>${_("Need help in registering with {platform_name}?").format(platform_name=platform_name)} <a href="${marketing_link('FAQ')}"> ${_("View our FAQs for answers to commonly asked questions.")}</a> ${_("Once registered, most questions can be answered in the course specific discussion forums or through the FAQs.")}</p>
          </div>

        % endif

      </div>
    </div>
  </div>
</section>
